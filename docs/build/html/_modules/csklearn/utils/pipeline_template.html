

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>csklearn.utils.pipeline_template &mdash; csklearn-doc 0.0.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> csklearn-doc
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"></div>
            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">csklearn-doc</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>csklearn.utils.pipeline_template</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for csklearn.utils.pipeline_template</h1><div class="highlight"><pre>
<span></span><span class="c1"># %% Load modules --------------------------------------------------------------</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">from</span> <span class="nn">html2text</span> <span class="kn">import</span> <span class="n">html2text</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">pickle</span> <span class="k">as</span> <span class="nn">pkl</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">UserWarning</span><span class="p">)</span>


<span class="c1"># SKLearn Modules</span>
<span class="kn">from</span> <span class="nn">sklearn.compose</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">sklearn.inspection</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">set_config</span>
<span class="n">set_config</span><span class="p">(</span><span class="n">display</span><span class="o">=</span><span class="s1">&#39;diagram&#39;</span><span class="p">)</span>


<span class="kn">from</span> <span class="nn">csklearn.transformers.VariableSelection</span> <span class="kn">import</span> <span class="o">*</span>



<div class="viewcode-block" id="pipeline_template"><a class="viewcode-back" href="../../../index.html#csklearn.utils.pipeline_template.pipeline_template">[docs]</a><span class="k">class</span> <span class="nc">pipeline_template</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base Class to help save and load pipelines to be reproducible. </span>

<span class="sd">    Instrucciones:</span>
<span class="sd">    - Al hacer save, el modelo se guarda si ha sido entrenado.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Select variables and define transform steps:\</span>
<span class="sd">        - Select variables and transform them:\</span>
<span class="sd">            &gt; dummy_tf_vars = [&#39;var1&#39;, &#39;var7&#39;, &#39;varN&#39;]</span>
<span class="sd">            &gt; dummy_tf = Pipeline(steps=[</span>
<span class="sd">                        (&#39;ft&#39;, FunctionTransformer()),</span>
<span class="sd">                        ])</span>
<span class="sd">        - Create steps and comment when you won&#39;t to use any set of variables:</span>
<span class="sd">            &gt; self.tf_steps = [</span>
<span class="sd">                        (&#39;dummy_tf&#39;, dummy_tf, dummy_tf_vars),</span>
<span class="sd">                        ]</span>

<span class="sd">        - Define an algorithm:</span>
<span class="sd">            &gt; self.algorithm = Ridge()</span>

<span class="sd">        - Define error function or metrics:</span>
<span class="sd">            &gt; mae = make_scorer(mean_absolute_error)</span>
<span class="sd">            &gt; r2  = make_scorer(r2_score)</span>
<span class="sd">            &gt; self.dict_metrics = {&#39;mae&#39;:mae, &#39;r2&#39;:r2}</span>

<span class="sd">        - (Optional) Define crossvalidation method for search best hyperparams.</span>
<span class="sd">            You can specify it in search method:</span>
<span class="sd">            &gt; self.CV = KFold(n_splits=5, shuffle=False, random_state=None)</span>

<span class="sd">            Source:</span>
<span class="sd">            [https://scikit-learn.org/stable/modules/classes.html#module-sklearn.model_selection]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># Mandatory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tf_steps</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dict_metrics</span> <span class="o">=</span> <span class="kc">None</span>      

        <span class="c1"># Optional</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dir_out</span> <span class="o">=</span> <span class="s1">&#39;tmp&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CV</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param_grid</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Memory for pipeline steps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dir_memory</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Intermediate pipe steps: example: use RF Feature Selector!</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intermediate_pipe_steps</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># To keep in class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_d_scorer</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_d_params</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_modelname</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Renombrar repetidos fits y resetear parametros si no son identicos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fit_counter</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="c1"># Flag_counter, fit, search</span>

        <span class="c1"># Pipeline (se construye poco a poco)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pipeline</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_final_predictors</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_df_search</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({})</span>
        <span class="c1"># self._d_cv_score = {}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_d_valid_score</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_d_valid_score_w</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># self._d_cv_score_p = {}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_p_search_time</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_p_ts</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_p_fit_time</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Default Directories</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dir_model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dir_objects</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dir_pipeline</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dir_info</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dir_plots</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dir_data</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Necessary attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_template_attributes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="c1">####</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d_search</span> <span class="o">=</span> <span class="kc">None</span>

    
    <span class="c1"># CUSTOMIZABLES</span>
    <span class="k">def</span> <span class="nf">set_dir_out</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dir_out</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dir_out</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">dir_out</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">set_CV</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">CV</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CV</span> <span class="o">=</span> <span class="n">CV</span>

    <span class="k">def</span> <span class="nf">set_param_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_grid</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param_grid</span> <span class="o">=</span> <span class="n">param_grid</span>

<div class="viewcode-block" id="pipeline_template.set_pipeline_params"><a class="viewcode-back" href="../../../index.html#csklearn.utils.pipeline_template.pipeline_template.set_pipeline_params">[docs]</a>    <span class="k">def</span> <span class="nf">set_pipeline_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d_params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to set params manually.</span>

<span class="sd">        Args:</span>
<span class="sd">            d_params (dict): dictionary with params</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_make_pipeline</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pipeline</span><span class="o">.</span><span class="n">set_params</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_d_params</span><span class="p">)</span></div>

    
    <span class="c1"># Search method</span>
<div class="viewcode-block" id="pipeline_template.search"><a class="viewcode-back" href="../../../index.html#csklearn.utils.pipeline_template.pipeline_template.search">[docs]</a>    <span class="k">def</span> <span class="nf">search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_th</span><span class="p">,</span> <span class="n">y_th</span><span class="p">,</span> <span class="n">CV</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">search_method</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">,</span> 
                <span class="n">param_grid</span> <span class="o">=</span> <span class="p">{},</span> <span class="n">refit</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
                <span class="n">result_name</span> <span class="o">=</span> <span class="s1">&#39;search&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Hyperparameters search method. It helps to construct and save and</span>
<span class="sd">            load hyperparameters.</span>

<span class="sd">        Args:</span>
<span class="sd">            search (object, optional): method to search hyperparameters. </span>
<span class="sd">                Defaults to GridSearchCV.</span>
<span class="sd">            CV (array, optional): array with indexes. Defaults to None.</span>
<span class="sd">            param_grid (dict, optional): dictionary with params to search. If it </span>
<span class="sd">            is not provided, then it uses the parameters stored by the class</span>
<span class="sd">                                        Defaults to {}.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">############################## CHECK INIT ##############################</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_init</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param_grid</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">param_grid</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Not params especified! Use fit instead!&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">param_grid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">param_grid</span> <span class="o">=</span> <span class="n">param_grid</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CV</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CV</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;CV not defined! Neccesary for search&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">CV</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>   
            <span class="bp">self</span><span class="o">.</span><span class="n">CV</span> <span class="o">=</span> <span class="n">CV</span>


        <span class="c1">################################ SEARCH ################################</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_make_pipeline</span><span class="p">()</span>
        <span class="n">search</span> <span class="o">=</span> <span class="n">search_method</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_pipeline</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">param_grid</span><span class="p">,</span>
                        <span class="n">cv</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">CV</span><span class="p">,</span>
                        <span class="n">scoring</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_d_scorer</span><span class="p">,</span>
                        <span class="n">refit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">verbose</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                        <span class="n">error_score</span><span class="o">=</span><span class="s1">&#39;raise&#39;</span><span class="p">,</span>
                        <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                        <span class="o">**</span><span class="n">kwargs</span>
                        <span class="p">)</span>

        <span class="c1">#try:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">search</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_th</span><span class="p">,</span> <span class="n">y_th</span><span class="p">)</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_p_search_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Hh %Mm %Ss&quot;</span><span class="p">,</span> 
                                            <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">(</span><span class="n">delta</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_p_search_time</span><span class="p">)</span>

        <span class="c1"># except ValueError:</span>
        <span class="c1">#     print(&#39;\n\nparam_grid is corectly defined??\nOPTIONS:\n&#39;)</span>
        <span class="c1">#     for x in self.help_params_names():</span>
        <span class="c1">#         print(&#39;- {}&#39;.format(x))</span>
        <span class="c1">#     raise Exception(&#39;\nYou can also use help_params_names() to get help!\n\n&#39;)</span>


        <span class="c1">############################# GET RESULTS ##############################</span>
        <span class="n">df_search</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">search</span><span class="o">.</span><span class="n">cv_results_</span><span class="p">)</span><span class="o">.</span>\
                        <span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;mean_test_&#39;</span><span class="o">+</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> 
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_d_scorer</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_df_search</span> <span class="o">=</span> <span class="n">df_search</span>
    
        <span class="n">main_score</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_d_scorer</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># Score Name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_d_params</span> <span class="o">=</span> <span class="n">df_search</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;params&#39;</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_d_params</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_search</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Search Params Best </span><span class="si">{}</span><span class="s1">:</span><span class="se">\n\t</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">main_score</span><span class="p">,</span> 
                                                                <span class="bp">self</span><span class="o">.</span><span class="n">_d_params</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pipeline</span><span class="o">.</span><span class="n">set_params</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_d_params</span><span class="p">)</span>
            <span class="c1"># self.cv_score(X_th, y_th, self.CV, result_name = result_name)</span>

        <span class="c1"># Ponemos a la par el flag y search para no reiniciar puntuaciones</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fit_counter</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit_counter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">refit</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_th</span><span class="p">,</span> <span class="n">y_th</span><span class="p">)</span></div>

        


    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="c1"># ESTE MÉTODO ES CLAVE. SI SE EJECUTA, SE DEBEN REINICIAR ATRIBUTOS</span>
        <span class="c1"># La idea es meter X como si fuera df_matrix, los predictores se selecc.</span>
        <span class="c1"># automaticamente con la arquitectura.</span>

        <span class="c1"># Checks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_init</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_make_pipeline</span><span class="p">()</span>
        
        <span class="c1"># Train pipeline</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pipeline</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_p_fit_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Hh %Mm %Ss&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">(</span><span class="n">delta</span><span class="p">))</span>

        <span class="c1"># Timestamp del entreno</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_p_ts</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">-%m-%Y %H:%M:%S&quot;</span><span class="p">)</span>

        <span class="c1"># Ponemos a la par el flag y fit (así se podrá guardar)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fit_counter</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit_counter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


        <span class="c1"># RESET ATTRIBUTES:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_d_valid_score</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_d_valid_score_w</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit_counter</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit_counter</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_df_search</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({})</span>
            <span class="c1"># self._d_cv_score = {}</span>
            <span class="c1"># self._d_cv_score_p = {}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_p_search_time</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># dir_model se queda no se cambia</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dir_objects</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dir_pipeline</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dir_info</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dir_plots</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dir_data</span> <span class="o">=</span> <span class="kc">None</span>


<div class="viewcode-block" id="pipeline_template.predict"><a class="viewcode-back" href="../../../index.html#csklearn.utils.pipeline_template.pipeline_template.predict">[docs]</a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">result_name</span><span class="p">:</span><span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">valid_window</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to predict</span>

<span class="sd">        Args:</span>
<span class="sd">            X (array): [description]</span>
<span class="sd">            y (array, optional): real values. If given, then it prints the </span>
<span class="sd">                result. Defaults to None.</span>
<span class="sd">            result_name (str, optional): argument to name the results. Defaults </span>
<span class="sd">                to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">y_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pipeline</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Have you fitted??&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>        
            <span class="bp">self</span><span class="o">.</span><span class="n">validation_score</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">result_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">valid_window</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validation_score_window</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">result_name</span> <span class="o">=</span> <span class="n">result_name</span><span class="p">,</span> 
                                                <span class="n">valid_window</span> <span class="o">=</span> <span class="n">valid_window</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">y_pred</span></div>


<div class="viewcode-block" id="pipeline_template.validation_score"><a class="viewcode-back" href="../../../index.html#csklearn.utils.pipeline_template.pipeline_template.validation_score">[docs]</a>    <span class="k">def</span> <span class="nf">validation_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">result_name</span><span class="p">:</span><span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;scores&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Used to determine validation score. Remember that you can use an </span>
<span class="sd">        arbitrary X with their respective y and predict the pipeline to see the</span>
<span class="sd">        performing</span>

<span class="sd">        Args:</span>
<span class="sd">            X ([type]): [description]</span>
<span class="sd">            y ([type]): [description]</span>
<span class="sd">            result_name (str, optional): validation set name. It is useful in </span>
<span class="sd">                case we have several sets, to be able to save them as different </span>
<span class="sd">                results. Defaults to &#39;score&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pipeline</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_d_valid_score</span><span class="p">[</span><span class="n">result_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Main Validation</span>
        <span class="k">for</span> <span class="n">namesc</span><span class="p">,</span> <span class="n">scorer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict_metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">scorer</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_d_valid_score</span><span class="p">[</span><span class="n">result_name</span><span class="p">][</span><span class="n">namesc</span><span class="p">]</span> <span class="o">=</span> <span class="n">score</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dir_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_save_objects</span><span class="p">(</span><span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_save_info</span><span class="p">(</span><span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">print_validation_score</span><span class="p">(</span><span class="n">html</span> <span class="o">=</span> <span class="kc">False</span><span class="p">))</span></div>

    
    <span class="k">def</span> <span class="nf">validation_score_window</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">valid_window</span><span class="p">,</span> 
                                                    <span class="n">result_name</span><span class="p">:</span><span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;scores&#39;</span><span class="p">):</span>

        <span class="n">y_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pipeline</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="c1">#Check if columns are in X:</span>
        <span class="n">needed_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">valid_window</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">needed_cols</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> columns are not in X matrix&#39;</span><span class="o">.</span>\
                <span class="nb">format</span><span class="p">(</span><span class="n">needed_cols</span><span class="p">))</span>
        <span class="n">df_aux</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">valid_window</span><span class="p">]</span>
        <span class="n">df_aux</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span>
        <span class="n">df_aux</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;y_pred&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">y_pred</span>
        <span class="n">df_aux</span> <span class="o">=</span> <span class="n">df_aux</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">valid_window</span><span class="p">)</span><span class="o">.</span>\
                                        <span class="n">agg</span><span class="p">({</span><span class="s1">&#39;y&#39;</span><span class="p">:</span><span class="nb">list</span><span class="p">,</span> <span class="s1">&#39;y_pred&#39;</span><span class="p">:</span><span class="nb">list</span><span class="p">})</span>
        <span class="k">for</span> <span class="n">namesc</span><span class="p">,</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict_metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">sufix</span> <span class="o">=</span> <span class="s1">&#39;__&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">valid_window</span><span class="p">)</span>
            <span class="n">df_aux</span><span class="p">[</span><span class="n">namesc</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_aux</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> 
                <span class="n">metric</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;y_pred&#39;</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_d_valid_score_w</span><span class="p">[</span><span class="n">sufix</span><span class="o">+</span><span class="s1">&#39;:  &#39;</span><span class="o">+</span><span class="n">result_name</span><span class="p">]</span> <span class="o">=</span> \
                                <span class="n">df_aux</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dict_metrics</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">print_validation_score_w</span><span class="p">(</span><span class="n">html</span> <span class="o">=</span> <span class="kc">False</span><span class="p">))</span>


        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dir_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_save_objects</span><span class="p">(</span><span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_save_info</span><span class="p">(</span><span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
                

    <span class="k">def</span> <span class="nf">_make_pipeline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># scorer function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_d_scorer</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">make_scorer</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict_metrics</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="c1"># Preprocessing initial variables</span>
        <span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tf_steps</span><span class="p">)</span>

        <span class="c1"># Utils: get final predictors</span>
        <span class="n">final_predictors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> 
                    <span class="n">preprocessor</span><span class="o">.</span><span class="n">get_params</span><span class="p">()[</span><span class="s1">&#39;transformers&#39;</span><span class="p">]])</span><span class="o">.</span>\
                    <span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="c1"># Start pipeline with neccesary vars</span>
        <span class="n">varselector</span> <span class="o">=</span> <span class="n">VariableSelection</span><span class="p">(</span><span class="n">final_predictors</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_memory</span><span class="p">:</span>
            <span class="n">pipe</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;varsel&#39;</span><span class="p">,</span> <span class="n">varselector</span><span class="p">)],</span> 
                            <span class="n">memory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dir_memory</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pipe</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;varsel&#39;</span><span class="p">,</span> <span class="n">varselector</span><span class="p">)],</span> <span class="n">verbose</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span>

        <span class="c1"># Add preprocessor</span>
        <span class="n">pipe</span><span class="o">.</span><span class="n">steps</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pipe</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span><span class="n">preprocessor</span><span class="p">))</span>                   

        <span class="c1"># Intermediate pipe steps (optional)</span>
        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">intermediate_pipe_steps</span><span class="p">:</span>
            <span class="n">pipe</span><span class="o">.</span><span class="n">steps</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pipe</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>

        <span class="c1"># Algorithm</span>
        <span class="n">pipe</span><span class="o">.</span><span class="n">steps</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pipe</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;estimator&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="p">))</span>
        

        <span class="bp">self</span><span class="o">.</span><span class="n">_pipeline</span> <span class="o">=</span> <span class="n">pipe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_final_predictors</span> <span class="o">=</span> <span class="n">final_predictors</span>

    
<div class="viewcode-block" id="pipeline_template.remove_validation_results"><a class="viewcode-back" href="../../../index.html#csklearn.utils.pipeline_template.pipeline_template.remove_validation_results">[docs]</a>    <span class="k">def</span> <span class="nf">remove_validation_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span><span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to remove results from validation. You must specify the row</span>
<span class="sd">        name.</span>

<span class="sd">        Args:</span>
<span class="sd">            key (str): row name. If &#39;all&#39;, then remove all rows!</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_d_valid_score</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_d_valid_score_w</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_d_valid_score</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_d_valid_score_w</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dir_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_save_objects</span><span class="p">(</span><span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_save_info</span><span class="p">(</span><span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="pipeline_template.activate_memory"><a class="viewcode-back" href="../../../index.html#csklearn.utils.pipeline_template.pipeline_template.activate_memory">[docs]</a>    <span class="k">def</span> <span class="nf">activate_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dir_memory</span><span class="p">:</span><span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;tmp&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to activate memory joblibs to sklearn pipelines. If the </span>
<span class="sd">        initial steps of a pipeline do not change, then they are not </span>
<span class="sd">        re-executed saving time and memory.</span>

<span class="sd">        WARNING!!! Be careful because if code changes are made in a </span>
<span class="sd">        transformation, but the form of the data array input is preserved, </span>
<span class="sd">        sklearn will read from the joblib and ignore the code changes in the </span>
<span class="sd">        transformation.</span>

<span class="sd">        Args:</span>
<span class="sd">            dir_memory (str, optional): path to save joblibs. Defaults to &#39;tmp&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dir_memory</span> <span class="o">=</span> <span class="n">dir_memory</span></div>



<div class="viewcode-block" id="pipeline_template.remove_memory"><a class="viewcode-back" href="../../../index.html#csklearn.utils.pipeline_template.pipeline_template.remove_memory">[docs]</a>    <span class="k">def</span> <span class="nf">remove_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to remove memory joblibs from sklearn pipelines.</span>

<span class="sd">        This method is very important</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dir_memory</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir_memory</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;joblib&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dir_memory</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">dir_memory</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Memory wiped!!&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No memory to be removed!&#39;</span><span class="p">)</span></div>

    
    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dir_out</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">model_alias</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">dir_out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dir_out</span> <span class="o">=</span> <span class="n">dir_out</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dir_out</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir_out</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Model directory in: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir_out</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">model_alias</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">model_alias</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">model_alias</span>

        <span class="c1"># Model Name Alias</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit_counter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit_counter</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The model has not yet been trained or has already been saved&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modelname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Si el flag es igual, y modelname no ha sido definido:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Note: You can also set an alias with model_alias argument&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_modelname</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">%H%M%S&quot;</span><span class="p">)</span>
                <span class="n">sufix</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fit_counter</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">+</span><span class="n">model_alias</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sufix</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fit_counter</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">+</span><span class="n">model_alias</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dir_model</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir_out</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_modelname</span><span class="o">+</span><span class="n">sufix</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dir_model</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
             <span class="c1"># Se añade 1 al flag contador</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fit_counter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit_counter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>

            <span class="c1"># Save by parts:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_save_pipeline</span><span class="p">(</span><span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>

            <span class="c1"># Print path</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Model saved in </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dir_model</span><span class="p">))</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">_save_objects</span><span class="p">(</span><span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_info</span><span class="p">(</span><span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="c1"># params_path = self._dir_model.joinpath(&#39;params&#39;)</span>
        <span class="c1"># data_path = self._dir_model.joinpath(&#39;data&#39;) </span>

    
<div class="viewcode-block" id="pipeline_template.load"><a class="viewcode-back" href="../../../index.html#csklearn.utils.pipeline_template.pipeline_template.load">[docs]</a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dir_out</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find pipeline_template from its folder. If dir_out is not completed,</span>
<span class="sd">        then it search in their child folder and select the most recent.</span>

<span class="sd">        Args:</span>
<span class="sd">            dir_out (Path or str): directory to model folder.</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: if model not found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dir_out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dir_out</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">dir_out</span><span class="p">)</span>
        
        <span class="c1"># Find the most recent file in dir_out if not model_name</span>
        <span class="n">all_models</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">help_saved_models</span><span class="p">(</span><span class="n">dir_out</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dir_model</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">all_models</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;No model found in </span><span class="si">{}</span><span class="s1">.</span><span class="se">\n\</span>
<span class="s1">Try to use help_saved_models() method&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dir_out</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_modelname</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dir_model</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_models</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Not model found. Try to use help_saved_models() method&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_models</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> folder has more than 1 model </span><span class="si">{}</span><span class="s1">.</span><span class="se">\n</span><span class="s1">Load </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span>\
                <span class="nb">format</span><span class="p">(</span><span class="n">dir_out</span><span class="p">,</span> <span class="n">all_models</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modelname</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">Load model from </span><span class="si">{}</span><span class="s1">:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dir_model</span><span class="p">))</span>

        <span class="c1"># Save by parts:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_objects</span><span class="p">(</span><span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;l&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_pipeline</span><span class="p">(</span><span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;l&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_info</span><span class="p">(</span><span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;l&#39;</span><span class="p">)</span> <span class="c1"># Should be after _save_pipeline! </span></div>


<div class="viewcode-block" id="pipeline_template.help_params_names"><a class="viewcode-back" href="../../../index.html#csklearn.utils.pipeline_template.pipeline_template.help_params_names">[docs]</a>    <span class="k">def</span> <span class="nf">help_params_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_str</span><span class="o">=</span><span class="s1">&#39;estimator__&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Función para filtrar los nombres de los parámetros que interesan </span>
<span class="sd">        del pipeline.</span>

<span class="sd">        Args:</span>
<span class="sd">            param_str (str, optional): Expresión regular a matchear. </span>
<span class="sd">                Defaults to &#39;estimator__&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_init</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_make_pipeline</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pipeline</span><span class="o">.</span><span class="n">get_params</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> 
                <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">param_str</span><span class="p">)</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span></div>


    <span class="k">def</span> <span class="nf">show_pipeline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_init</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_make_pipeline</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pipeline</span>


<div class="viewcode-block" id="pipeline_template.help_saved_models"><a class="viewcode-back" href="../../../index.html#csklearn.utils.pipeline_template.pipeline_template.help_saved_models">[docs]</a>    <span class="k">def</span> <span class="nf">help_saved_models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dir_model</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Función buscar los modelos guardados</span>

<span class="sd">        Args:</span>
<span class="sd">            dir_model (str, optional): Path al directorio.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dir_model</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;/**/&#39;</span><span class="p">,</span><span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
                    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;.*\d</span><span class="si">{14}</span><span class="s1">F\d[_\w+]+/$&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span></div>


    <span class="k">def</span> <span class="nf">_save_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dir_objects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dir_model</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;objects&#39;</span><span class="p">)</span> <span class="c1"># update</span>
        <span class="n">d_aux</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> 
                        <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_template_attributes</span><span class="o">+</span><span class="p">[</span><span class="s1">&#39;_template_attributes&#39;</span><span class="p">]}</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;w&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dir_objects</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">d_aux</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dir_objects</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out</span><span class="p">:</span>
                    <span class="n">pkl</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;l&#39;</span><span class="p">:</span>
            <span class="n">dict_objects</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">d_aux</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dir_objects</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">_in</span><span class="p">:</span>
                    <span class="c1"># Load attribute</span>
                    <span class="n">dict_objects</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">pkl</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">_in</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span> <span class="o">=</span> <span class="n">dict_objects</span>


    <span class="k">def</span> <span class="nf">_save_pipeline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dir_pipeline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dir_model</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;pipeline&#39;</span><span class="p">)</span> <span class="c1"># update</span>
        <span class="n">name_out</span> <span class="o">=</span> <span class="s1">&#39;pipeline&#39;</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;w&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dir_pipeline</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dir_pipeline</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">name_out</span><span class="o">+</span><span class="s1">&#39;.pkl&#39;</span><span class="p">),</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out</span><span class="p">:</span>
                <span class="n">pkl</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pipeline</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;l&#39;</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dir_pipeline</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">name_out</span><span class="o">+</span><span class="s1">&#39;.pkl&#39;</span><span class="p">),</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">_in</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pipeline</span> <span class="o">=</span> <span class="n">pkl</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">_in</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_save_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dir_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dir_model</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;info&#39;</span><span class="p">)</span> <span class="c1"># update</span>
        <span class="n">name_out</span> <span class="o">=</span> <span class="s1">&#39;pipeline&#39;</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;w&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dir_info</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dir_info</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">name_out</span><span class="o">+</span><span class="s1">&#39;.txt&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_add_html_info</span><span class="p">(</span><span class="n">html</span> <span class="o">=</span> <span class="kc">False</span><span class="p">))</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dir_info</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">name_out</span><span class="o">+</span><span class="s1">&#39;.html&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>                    
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_add_html_info</span><span class="p">(</span><span class="n">html</span> <span class="o">=</span> <span class="kc">True</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;l&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_add_html_info</span><span class="p">(</span><span class="n">html</span> <span class="o">=</span> <span class="kc">False</span><span class="p">))</span>


<div class="viewcode-block" id="pipeline_template.save_plot"><a class="viewcode-back" href="../../../index.html#csklearn.utils.pipeline_template.pipeline_template.save_plot">[docs]</a>    <span class="k">def</span> <span class="nf">save_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">figure</span><span class="p">,</span> <span class="n">fig_alias</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to save plot in correct folder</span>

<span class="sd">        Args:</span>
<span class="sd">            figure (fig): Matplotlib figure.</span>
<span class="sd">            fig_alias (str): figure name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dir_plots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dir_model</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;plots&#39;</span><span class="p">)</span> <span class="c1"># update</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dir_pipeline</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;First you must save your model with save() method&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_dir_plots</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">figure</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dir_plots</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">fig_alias</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_info</span><span class="p">(</span><span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="c1"># Update info</span></div>

    
    <span class="k">def</span> <span class="nf">save_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">X_name</span> <span class="o">=</span> <span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">y_name</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> 
                        <span class="n">dir_data</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dir_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dir_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Specify dir_data argument or </span><span class="se">\</span>
<span class="s1">save your model with save() method (will saved in dir_model folder)&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dir_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dir_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dir_model</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">)</span> <span class="c1"># update</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Using model directory to save data: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span>\
                                                        <span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dir_data</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dir_data</span> <span class="o">=</span> <span class="n">dir_data</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Data saved in specified directory: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span>\
                                                        <span class="nb">format</span><span class="p">(</span><span class="n">dir_data</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dir_data</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">X</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">X</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dir_data</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">X_name</span><span class="o">+</span><span class="s1">&#39;.csv&#39;</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">y</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dir_data</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">y_name</span><span class="o">+</span><span class="s1">&#39;.csv&#39;</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        
        <span class="c1"># Update objects:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_objects</span><span class="p">(</span><span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        
        <span class="c1"># Update info: TODO</span>
        <span class="c1"># dir_data saved in ...</span>

    
    <span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_name</span> <span class="o">=</span> <span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">y_name</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">dir_data</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dir_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dir_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;No data to load has been specified!&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dir_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dir_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dir_data</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Load data from: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dir_data</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">X_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">dir_data</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">X_name</span><span class="o">+</span><span class="s1">&#39;.csv&#39;</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">y_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">dir_data</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">y_name</span><span class="o">+</span><span class="s1">&#39;.csv&#39;</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span>

    
    <span class="k">def</span> <span class="nf">print_validation_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">html</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_d_valid_score</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">html</span><span class="p">:</span>
                <span class="n">p_score</span> <span class="o">=</span> <span class="s1">&#39;&lt;h2&gt;VALIDATION SCORES:&lt;/h2&gt;&lt;br&gt;&#39;</span>        
                <span class="n">p_score</span><span class="o">+=</span><span class="nb">round</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_d_valid_score</span><span class="p">),</span> <span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">to_html</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">p_score</span> 
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p_score</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">VALIDATION SCORES:&#39;</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d_valid_score</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">p_score</span><span class="o">+=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&gt; </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">p_score</span><span class="o">+=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">- </span><span class="si">{}</span><span class="s1">: </span><span class="si">{:.4f}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">score</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">p_score</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span>
    

    <span class="k">def</span> <span class="nf">print_validation_score_w</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">html</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_d_valid_score_w</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">html</span><span class="p">:</span>
                <span class="n">p_score</span> <span class="o">=</span> <span class="s1">&#39;&lt;h2&gt;VALIDATION SCORES BY WINDOW:&lt;/h2&gt;&lt;br&gt;&#39;</span>  
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d_valid_score_w</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">p_score</span><span class="o">+=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&lt;br&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                    <span class="n">p_score</span><span class="o">+=</span><span class="nb">round</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">to_html</span><span class="p">()</span>
                    <span class="n">p_score</span><span class="o">+=</span><span class="s1">&#39;&lt;br&gt;&#39;</span>
                <span class="k">return</span> <span class="n">p_score</span> 
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p_score</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">VALIDATION SCORES BY WINDOW:&#39;</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d_valid_score_w</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">p_score</span><span class="o">+=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&gt; </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">k2</span><span class="p">,</span><span class="n">v2</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>  
                        <span class="n">p_score</span><span class="o">+=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&gt;&gt; </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k2</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">namesc</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">v2</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="n">p_score</span><span class="o">+=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">- </span><span class="si">{}</span><span class="s1">: </span><span class="si">{:.4f}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">namesc</span><span class="p">,</span><span class="n">score</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">p_score</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span>


    <span class="k">def</span> <span class="nf">print_cv_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">html</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span> 
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df_search</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">df_cv</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df_search</span><span class="o">.</span>\
                        <span class="nb">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="s1">&#39;mean_test|std_test&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[[</span><span class="mi">0</span><span class="p">],:],</span> <span class="mi">4</span><span class="p">)</span>
            <span class="n">df_cv</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span>
            <span class="n">df_cv</span> <span class="o">=</span> <span class="n">df_cv</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">k</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_test&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> 
                                                            <span class="ow">in</span> <span class="n">df_cv</span><span class="o">.</span><span class="n">columns</span><span class="p">})</span>     
                            
            <span class="k">if</span> <span class="n">html</span><span class="p">:</span>
                <span class="n">p_score</span> <span class="o">=</span> <span class="s1">&#39;&lt;h2&gt;CROSSVALIDATION SCORES:&lt;/h2&gt;&lt;br&gt;&#39;</span>
                <span class="n">p_score</span><span class="o">+=</span><span class="n">df_cv</span><span class="o">.</span><span class="n">to_html</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">p_score</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p_score</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">CROSSVALIDATION SCORES:&#39;</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">df_cv</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">p_score</span><span class="o">+=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&gt; </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">p_score</span><span class="o">+=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">- </span><span class="si">{}</span><span class="s1">: </span><span class="si">{:.4f}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">score</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">p_score</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span>



    
    <span class="k">def</span> <span class="nf">_add_html_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">add_plots</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">html</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">html</span><span class="p">:</span>
            <span class="n">p_cv_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">print_cv_score</span><span class="p">(</span><span class="n">html</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">p_valid_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">print_validation_score</span><span class="p">(</span><span class="n">html</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">p_valid_score_w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">print_validation_score_w</span><span class="p">(</span><span class="n">html</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">pipeline_p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pipeline</span><span class="o">.</span><span class="n">_repr_html_</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p_cv_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">print_cv_score</span><span class="p">(</span><span class="n">html</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">p_valid_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">print_validation_score</span><span class="p">(</span><span class="n">html</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">p_valid_score_w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">print_validation_score_w</span><span class="p">(</span><span class="n">html</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">pipeline_p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pipeline</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span>

        <span class="n">main_html</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">            &lt;h2&gt;ARCHITECTURE:&lt;/h2&gt;</span>
<span class="s1">            </span><span class="si">{}</span><span class="s1"></span>
<span class="s1">            &lt;br&gt;&lt;br&gt;</span>
<span class="s1">            </span><span class="si">{}</span><span class="s1"></span>
<span class="s1">            &lt;br&gt;&lt;br&gt;</span>
<span class="s1">            </span><span class="si">{}</span><span class="s1"></span>
<span class="s1">            &lt;br&gt;&lt;br&gt;</span>
<span class="s1">            </span><span class="si">{}</span><span class="s1"></span>
<span class="s1">            &lt;br&gt;&lt;br&gt;</span>
<span class="s1">            &lt;h2&gt;EXECUTION INFO:&lt;/h2&gt;</span>
<span class="s1">            - Fit Time: </span><span class="si">{}</span><span class="s1">&lt;br&gt;</span>
<span class="s1">            - Fit timestamp: </span><span class="si">{}</span><span class="s1">&lt;br&gt;</span>
<span class="s1">            - Search Hyperparameters Time: </span><span class="si">{}</span><span class="s1"></span>
<span class="s1">            &lt;br&gt;&lt;br&gt;</span>
<span class="s1">            &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pipeline_p</span><span class="p">,</span>
                        <span class="n">p_cv_score</span><span class="p">,</span> <span class="n">p_valid_score</span><span class="p">,</span> <span class="n">p_valid_score_w</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_p_fit_time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p_ts</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_p_search_time</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">html</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">html2text</span><span class="p">(</span><span class="n">main_html</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;br&gt;&#39;</span><span class="p">))</span> <span class="c1">#Truco</span>

        <span class="c1"># To add plots in html from plot folder</span>
        <span class="n">imgs_paths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">add_plots</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dir_plots</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">imgs_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">Path</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> 
                                <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dir_plots</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;/*&#39;</span><span class="p">))]</span>
            <span class="n">main_html</span><span class="o">+=</span><span class="s1">&#39;&#39;&#39;&lt;h2&gt;FIGURES&lt;/h2&gt;&lt;br&gt;&#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">imgs_paths</span><span class="p">:</span>
            <span class="n">main_html</span><span class="o">+=</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">            &lt;body&gt;</span>
<span class="s1">                &lt;img src=&quot;</span><span class="si">{}</span><span class="s1">&quot;/&gt;&lt;br&gt;&lt;br&gt;</span>
<span class="s1">            &lt;/body&gt;&#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;../&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_dir_plots</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">img</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">main_html</span><span class="p">)</span>



    <span class="k">def</span> <span class="nf">_check_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tf_steps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;tf_steps not defined!&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;algorithm not defined!&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict_metrics</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;error_function not defined!&#39;</span><span class="p">)</span>

        <span class="c1"># if self.CV is None:</span>
        <span class="c1">#     warnings.warn(&#39;CV is recommendable to define in the architecture&#39;)</span>


    <span class="k">def</span> <span class="nf">plot_permutation_importance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">n_repeats</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> 
                    <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Permutation Importances&#39;</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">permutation_importance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pipeline</span><span class="p">,</span> 
                                        <span class="n">X</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_final_predictors</span><span class="p">],</span> <span class="n">y</span><span class="p">,</span> 
                                        <span class="n">n_repeats</span><span class="o">=</span><span class="n">n_repeats</span><span class="p">,</span>
                                        <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                                        <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">sorted_idx</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">importances_mean</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">importances</span><span class="p">[</span><span class="n">sorted_idx</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                    <span class="n">vert</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                    <span class="n">labels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_final_predictors</span><span class="p">)[</span><span class="n">sorted_idx</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Daniel Runeda.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>